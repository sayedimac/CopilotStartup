@page "/tabledata"
@inject HttpClient Http

<PageTitle>Table Storage</PageTitle>

<h1>Azure Table Storage Browser</h1>

<div class="row mb-3">
    <div class="col-md-4">
        <label for="tableName" class="form-label">Table Name:</label>
        <input type="text" id="tableName" class="form-control" @bind="tableName" placeholder="Enter table name" />
    </div>
    <div class="col-md-3">
        <label for="partitionKey" class="form-label">Partition Key:</label>
        <input type="text" id="partitionKey" class="form-control" @bind="partitionKey" placeholder="Partition key" />
    </div>
    <div class="col-md-3">
        <label for="rowKey" class="form-label">Row Key:</label>
        <input type="text" id="rowKey" class="form-control" @bind="rowKey" placeholder="Row key" />
    </div>
    <div class="col-md-2 d-flex align-items-end">
        <button class="btn btn-primary" @onclick="LoadTableData">Load Data</button>
    </div>
</div>

@if (loading)
{
    <p><em>Loading table data...</em></p>
}
else if (!string.IsNullOrEmpty(errorMessage))
{
    <div class="alert alert-danger" role="alert">
        @errorMessage
    </div>
}
else if (tableData != null)
{
    <div class="card">
        <div class="card-header">
            <h4>Table: @tableData.TableName</h4>
        </div>
        <div class="card-body">
            <table class="table table-striped">
                <tbody>
                    <tr>
                        <th>Partition Key</th>
                        <td>@tableData.PartitionKey</td>
                    </tr>
                    <tr>
                        <th>Row Key</th>
                        <td>@tableData.RowKey</td>
                    </tr>
                    <tr>
                        <th>Timestamp</th>
                        <td>@tableData.Timestamp</td>
                    </tr>
                </tbody>
            </table>

            @if (tableData.Properties.Any())
            {
                <h5 class="mt-3">Properties:</h5>
                <table class="table table-bordered">
                    <thead>
                        <tr>
                            <th>Property Name</th>
                            <th>Value</th>
                        </tr>
                    </thead>
                    <tbody>
                        @foreach (var prop in tableData.Properties)
                        {
                            <tr>
                                <td>@prop.Key</td>
                                <td>@prop.Value</td>
                            </tr>
                        }
                    </tbody>
                </table>
            }
        </div>
    </div>
}

@code {
    private string tableName = "TestTable";
    private string partitionKey = "partition1";
    private string rowKey = "row1";
    private TableEntityData? tableData;
    private bool loading = false;
    private string? errorMessage;

    private async Task LoadTableData()
    {
        if (string.IsNullOrWhiteSpace(tableName) || string.IsNullOrWhiteSpace(partitionKey) || string.IsNullOrWhiteSpace(rowKey))
        {
            errorMessage = "Please enter table name, partition key, and row key";
            return;
        }

        loading = true;
        errorMessage = null;
        tableData = null;

        try
        {
            var apiUrl = $"/api/table/{tableName}/{partitionKey}/{rowKey}";
            tableData = await Http.GetFromJsonAsync<TableEntityData>(apiUrl);
        }
        catch (HttpRequestException ex)
        {
            errorMessage = $"Error loading table data: {ex.Message}";
        }
        catch (Exception ex)
        {
            errorMessage = $"Unexpected error: {ex.Message}";
        }
        finally
        {
            loading = false;
        }
    }

    private class TableEntityData
    {
        public string TableName { get; set; } = string.Empty;
        public string PartitionKey { get; set; } = string.Empty;
        public string RowKey { get; set; } = string.Empty;
        public DateTime? Timestamp { get; set; }
        public Dictionary<string, object> Properties { get; set; } = new();
    }
}
